From e8825b91acee68b6fdbc0139407df2d0bcb15263 Mon Sep 17 00:00:00 2001
From: chalesyu <574249312@qq.com>
Date: Wed, 4 Aug 2021 00:00:00 +0800
Subject: [PATCH 6/6] make u-boot init ac200-ephy on H6 board

---
 arch/arm/dts/sun50i-h6-tanix-tx6.dts  | 12 ++++++++++-
 arch/arm/dts/sun50i-h6.dtsi           |  7 +++++++
 arch/arm/mach-sunxi/Kconfig           |  2 +-
 arch/arm/mach-sunxi/clock_sun50i_h6.c |  3 +++
 board/sunxi/board.c                   | 30 +++++++++++++++++++++++++++
 configs/tanix_tx6_defconfig           |  3 +++
 configs/tanix_tx6_lpddr3_defconfig    |  3 +++
 drivers/net/sun8i_emac.c              |  2 +-
 include/configs/sunxi-common.h        |  2 +-
 9 files changed, 60 insertions(+), 4 deletions(-)

diff --git a/arch/arm/dts/sun50i-h6-tanix-tx6.dts b/arch/arm/dts/sun50i-h6-tanix-tx6.dts
index 089b4f733d..cbbe020583 100644
--- a/arch/arm/dts/sun50i-h6-tanix-tx6.dts
+++ b/arch/arm/dts/sun50i-h6-tanix-tx6.dts
@@ -13,6 +13,7 @@
 	compatible = "oranth,tanix-tx6", "allwinner,sun50i-h6";
 
 	aliases {
+		ethernet0 = &emac;
 		serial0 = &uart0;
 	};
 
@@ -104,8 +105,10 @@
 };
 
 &emac {
+	pinctrl-names = "default";
+	pinctrl-0 = <&ext_rmii_pins>;
 	phy-mode = "rmii";
-	//phy-handle = <&ext_rmii_phy>;
+	phy-handle = <&rmii_phy>;
 	status = "okay";
 };
 
@@ -119,6 +122,13 @@
 	};
 };
 
+&mdio {
+	rmii_phy: ethernet-phy@1 {
+		compatible = "ethernet-phy-ieee802.3-c22";
+		reg = <1>;
+	};
+};
+
 &mmc0 {
 	pinctrl-names = "default";
 	pinctrl-0 = <&mmc0_pins>;
diff --git a/arch/arm/dts/sun50i-h6.dtsi b/arch/arm/dts/sun50i-h6.dtsi
index 45f26a2ee2..71d03d99c0 100644
--- a/arch/arm/dts/sun50i-h6.dtsi
+++ b/arch/arm/dts/sun50i-h6.dtsi
@@ -313,6 +313,13 @@
 				drive-strength = <40>;
 			};
 
+			ext_rmii_pins: rmii_pins {
+				pins = "PA0", "PA1", "PA2", "PA3", "PA4",
+				       "PA5", "PA6", "PA7", "PA8", "PA9";
+				function = "emac";
+				drive-strength = <40>;
+			};
+
 			hdmi_pins: hdmi-pins {
 				pins = "PH8", "PH9", "PH10";
 				function = "hdmi";
diff --git a/arch/arm/mach-sunxi/Kconfig b/arch/arm/mach-sunxi/Kconfig
index 0135575ca1..c23bb3e28c 100644
--- a/arch/arm/mach-sunxi/Kconfig
+++ b/arch/arm/mach-sunxi/Kconfig
@@ -773,7 +773,7 @@ config I2C2_ENABLE
 	---help---
 	See I2C0_ENABLE help text.
 
-if MACH_SUN6I || MACH_SUN7I
+if MACH_SUN6I || MACH_SUN7I || SUN50I_GEN_H6
 config I2C3_ENABLE
 	bool "Enable I2C/TWI controller 3"
 	default n
diff --git a/arch/arm/mach-sunxi/clock_sun50i_h6.c b/arch/arm/mach-sunxi/clock_sun50i_h6.c
index 492fc4a3fc..1303070e3e 100644
--- a/arch/arm/mach-sunxi/clock_sun50i_h6.c
+++ b/arch/arm/mach-sunxi/clock_sun50i_h6.c
@@ -32,6 +32,9 @@ void clock_init_safe(void)
 	 * DRAM initialization code.
 	 */
 	writel(MBUS_CLK_SRC_PLL6X2 | MBUS_CLK_M(3), &ccm->mbus_cfg);
+
+	writel(0x10001, 0x030017ac);
+	writel(0x1000000, 0x0300a000);
 }
 #endif
 
diff --git a/board/sunxi/board.c b/board/sunxi/board.c
index b2af49c475..25cfe49171 100644
--- a/board/sunxi/board.c
+++ b/board/sunxi/board.c
@@ -14,6 +14,7 @@
 #include <dm.h>
 #include <env.h>
 #include <hang.h>
+#include <i2c.h>
 #include <image.h>
 #include <init.h>
 #include <log.h>
@@ -208,6 +209,17 @@ void i2c_init_board(void)
 	sunxi_gpio_set_cfgpin(SUNXI_GPL(1), SUN8I_H3_GPL_R_TWI);
 #endif
 #endif
+
+	/* I2C3 */
+	sunxi_gpio_set_cfgpin(SUNXI_GPB(17), 2);
+	sunxi_gpio_set_cfgpin(SUNXI_GPB(18), 2);
+	sunxi_gpio_set_pull(SUNXI_GPB(17), SUNXI_GPIO_PULL_UP);
+	sunxi_gpio_set_pull(SUNXI_GPB(18), SUNXI_GPIO_PULL_UP);
+	clock_twi_onoff(3, 1);
+
+	/* PWM1 */
+	sunxi_gpio_set_cfgpin(SUNXI_GPB(19), 2);
+
 }
 
 #if defined(CONFIG_ENV_IS_IN_MMC) && defined(CONFIG_ENV_IS_IN_FAT)
@@ -646,6 +658,7 @@ static void sunxi_spl_store_dram_size(phys_addr_t dram_size)
 void sunxi_board_init(void)
 {
 	int power_failed = 0;
+	u8 data[2];
 
 #ifdef CONFIG_SY8106A_POWER
 	power_failed = sy8106a_set_vout1(CONFIG_SY8106A_VOUT1_VOLT);
@@ -725,6 +738,23 @@ void sunxi_board_init(void)
 		clock_set_pll1(CONFIG_SYS_CLK_FREQ);
 	else
 		printf("Failed to set core voltage! Can't set CPU frequency\n");
+
+
+	data[0] = 0;
+	data[1] = 0;
+	i2c_write(0x10, 0xfe, 1, data, 2);
+	i2c_write(0x10, 2, 1, data, 2);
+	data[1] = 1;
+	i2c_write(0x10, 2, 1, data, 2);
+	data[1] = 0xf;
+	i2c_write(0x10, 0x16, 1, data, 2);
+	data[1] = 3;
+	i2c_write(0x10, 0x14, 1, data, 2);
+	data[1] = 0x60;
+	i2c_write(0x10, 0xfe, 1, data, 2);
+	data[0] = 0x08;
+	data[1] = 0x14;
+	i2c_write(0x10, 0, 1, data, 2);
 }
 #endif
 
diff --git a/configs/tanix_tx6_defconfig b/configs/tanix_tx6_defconfig
index 9ce812ecc3..89c37dd403 100644
--- a/configs/tanix_tx6_defconfig
+++ b/configs/tanix_tx6_defconfig
@@ -8,3 +8,6 @@ CONFIG_MMC0_CD_PIN="PF6"
 CONFIG_MMC_SUNXI_SLOT_EXTRA=2
 CONFIG_DEFAULT_DEVICE_TREE="sun50i-h6-tanix-tx6"
 # CONFIG_SYS_MALLOC_CLEAR_ON_INIT is not set
+CONFIG_SPL_I2C_SUPPORT=y
+CONFIG_SUN8I_EMAC=y
+CONFIG_I2C3_ENABLE=y
diff --git a/configs/tanix_tx6_lpddr3_defconfig b/configs/tanix_tx6_lpddr3_defconfig
index 6f9882a9b1..9a04d20234 100644
--- a/configs/tanix_tx6_lpddr3_defconfig
+++ b/configs/tanix_tx6_lpddr3_defconfig
@@ -7,3 +7,6 @@ CONFIG_MMC0_CD_PIN="PF6"
 CONFIG_MMC_SUNXI_SLOT_EXTRA=2
 CONFIG_DEFAULT_DEVICE_TREE="sun50i-h6-tanix-tx6"
 # CONFIG_SYS_MALLOC_CLEAR_ON_INIT is not set
+CONFIG_SPL_I2C_SUPPORT=y
+CONFIG_SUN8I_EMAC=y
+CONFIG_I2C3_ENABLE=y
diff --git a/drivers/net/sun8i_emac.c b/drivers/net/sun8i_emac.c
index a6cdda81a7..cb339e5dfa 100644
--- a/drivers/net/sun8i_emac.c
+++ b/drivers/net/sun8i_emac.c
@@ -559,7 +559,7 @@ static int parse_phy_pins(struct udevice *dev)
 	else if (IS_ENABLED(CONFIG_MACH_SUN8I_R40))
 		iomux = SUN8I_IOMUX_R40;
 	else if (IS_ENABLED(CONFIG_MACH_SUN50I_H6))
-		iomux = SUN8I_IOMUX_H6;
+		iomux = 2;
 	else if (IS_ENABLED(CONFIG_MACH_SUN50I_H616))
 		iomux = SUN8I_IOMUX_H616;
 	else
diff --git a/include/configs/sunxi-common.h b/include/configs/sunxi-common.h
index 7b602dd9ea..f434efdb75 100644
--- a/include/configs/sunxi-common.h
+++ b/include/configs/sunxi-common.h
@@ -200,7 +200,7 @@
 #define CONFIG_SYS_I2C_MVTWSI
 #if !CONFIG_IS_ENABLED(DM_I2C)
 #define CONFIG_SYS_I2C
-#define CONFIG_SYS_I2C_SPEED		400000
+#define CONFIG_SYS_I2C_SPEED		100000
 #define CONFIG_SYS_I2C_SLAVE		0x7f
 #endif
 #endif
-- 

